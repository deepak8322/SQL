-- Create sample data
use database sql_learning_db;
use role accountadmin;
USE SCHEMA ECOMMERCE;
-- --------------------------------------------------
-- Question 1: Monthly Sales Query
--     Write an SQL query to retrieve the monthly sales summary
--     from the ORDERS table.
--     The query should:
--         - Display the order month and year
--         - Calculate the total number of orders per month
--         - Calculate the total revenue per month
--         - Calculate the average order value per month
--         - Sort the result by month in ascending order
-- --------------------------------------------------
SELECT
    YEAR(order_date) AS order_year,
    MONTH(order_date) AS order_month,
    COUNT(*) AS total_orders,
    SUM(total_amount) AS total_revenue,
    AVG(total_amount) AS avg_order_value
FROM
    orders
GROUP BY
    YEAR(order_date),
    MONTH(order_date)
ORDER BY
    order_year,
    order_month;
-- --------------------------------------------------
    -- Question 2: City-wise Customer and Order Query
    --     Write an SQL query using the CUSTOMERS and ORDERS tables
    --     to display city-wise and state-wise statistics.
    --     The query should:
    --         - Show city and state
    --         - Count the total number of distinct customers
    --         - Count the total number of orders
    --         - Calculate the total revenue per city
    --         - Include customers who have not placed any orders
    --         - Sort the result by total revenue in descending order
    -- --------------------------------------------------
SELECT
    c.city,
    c.state,
    COUNT(DISTINCT c.customer_id) AS total_customers,
    COUNT(o.order_id) AS total_orders,
    COALESCE(SUM(o.total_amount), 0) AS total_revenue
FROM
    customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY
    c.city,
    c.state
ORDER BY
    total_revenue DESC;
-- --------------------------------------------------
    -- Question 3: Product Category Performance Query
    --     Write an SQL query using the PRODUCTS and ORDER_ITEMS tables
    --     to analyze product category performance.
    --     The query should:
    --         - Display product category
    --         - Count the number of distinct products in each category
    --         - Calculate the total units sold per category
    --         - Calculate total revenue per category
    --         - Include categories with no sales
    --         - Sort the result by revenue in descending order
    -- --------------------------------------------------
SELECT
    p.category,
    COUNT(DISTINCT p.product_id) AS distinct_products,
    SUM(oi.quantity) AS total_units_sold,
    SUM(oi.quantity * oi.unit_price) AS total_revenue
FROM
    products p
    JOIN order_items oi ON p.product_id = oi.product_id
GROUP BY
    p.category
ORDER BY
    total_revenue DESC;
-- --------------------------------------------------
    -- Question 4: Customer Purchase History Query
    --     Write an SQL query to display the complete purchase history
    --     of a customer named "Amit Kumar".
    --     The query should:
    --         - Retrieve customer details, order details, and product details
    --         - Display product quantity, unit price, and line total
    --         - Include order status
    --         - Sort the results by order date in descending order
    -- --------------------------------------------------
SELECT
    c.customer_name,
    c.email,
    c.city,
    c.registration_date,
    o.order_id,
    o.order_date,
    o.status,
    p.product_name,
    oi.quantity,
    oi.unit_price,
    (oi.quantity * oi.unit_price) AS line_total
FROM
    customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
    LEFT JOIN order_items oi ON o.order_id = oi.order_id
    LEFT JOIN products p ON oi.product_id = p.product_id
WHERE
    c.customer_name = 'Amit Kumar'
ORDER BY
    o.order_date DESC;
-- --------------------------------------------------
    -- Question 5: Pending Orders Query
    --     Write an SQL query to list all orders that are pending delivery.
    --     The query should:
    --         - Include orders with statuses Processing and Shipped
    --         - Display order details along with customer name, email, and city
    --         - Sort the results by order date
    --------------------------------------------------
select
    c.customer_name,
    c.email,
    c.city
from
    orders o
    left join customers c on o.customer_id = c.customer_id
where
    o.status = 'Processing'
    or o.status = 'Shipped'
order by
    order_date;
-- --------------------------------------------------
    -- Question 6: Product Inventory Value Query
    --     Write an SQL query to calculate the inventory value for each
    --     product in the PRODUCTS table.
    --     The query should:
    --         - Display product name, category, price, and stock quantity
    --         - Calculate inventory value for each product
    --         - Include only products with available stock
    --         - Sort the result by inventory value in descending order
    -- --------------------------------------------------
select
    p.product_name,
    p.category,
    p.price,
    p.stock_quantity,
    (p.price * p.stock_quantity) as Inventory_Value,
    (p.stock_quantity - oi.quantity) as Current_stock
from
    products p
    left join order_items oi on p.product_id = oi.product_id
where
    p.stock_quantity > 0
order by
    Inventory_Value;